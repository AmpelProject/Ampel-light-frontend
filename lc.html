<body>

<head>
  <!-- Plotly.js -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="cutout-zoom.css">
  
  <style>
    .anyClass {
  height:280px;
  overflow-y: scroll;
}
.anyClass2 {
  height:280px;
  overflow-y: scroll;
  font-size: 18px;
}

  </style>

  <script src="config.js"></script>

  <script src="load_data.js"></script>

  <script src="toolbox.js"></script>

  <script src="fits/gzip.js"></script>
  <script src="fits/fits.js"></script>
  <script src="fits/fitsviewer.js"></script>

  <script>
    function get_stamp_url(pp, channel_config) {
      if (pp.content.alFlags.includes(23)) {
        return channel_config.cutouts.public+"/download?files="+pp.content._id['$numberLong']+".tgz";
      } else if (pp.content.alFlags.includes(22)) {
        return channel_config.cutouts.partnership+"/download?files="+pp.content._id['$numberLong']+".tgz";
      }
    }
    function get_plotly_data(d_, channel_config) {
        return {"x": d_.map( function(d) {return julianDateToDate(d.content.jd);} ),
                "y": d_.map( function(d) {return d.content.magpsf;} ),
                "dy": d_.map( function(d) {return d.content.sigmapsf;} ),
                "fid":d_.map( function(d) {return d.content.fid;}),
                "id":d_.map( function(d) {return d.content._id['$numberLong'];}),
                "cutoutURL":d_.map( function(d) { return get_stamp_url(d, channel_config); } ),
                // For Plotting
                "colors":d_.map( function(d) {return ZTFDATA[d.content.fid].color;}),
              }
      };

    function get_plotly_upperlimit(d_) {
        return {"x": d_.map( function(d) {return julianDateToDate(d.content.jd);} ),
                "y": d_.map( function(d) {return d.content.diffmaglim;} ),
                "fid":d_.map( function(d) {return d.content.fid;} ),
                // For Plotting
                "colors":d_.map( function(d) {return ZTFDATA[d.content.fid].color;}),
              }
    };

    function load_sdss_image(transient) {
      document.getElementById("sdsslink").setAttribute("href", "http://skyserver.sdss.org/dr14/en/tools/chart/navi.aspx?opt=G&ra="+transient.ra+"&dec="+transient.dec+"&scale=0.1981");
      var sdssimg = document.getElementById("sdssimg");
      sdssimg.setAttribute("src", "http://skyservice.pha.jhu.edu/DR14/ImgCutout/getjpeg.aspx?ra="+transient.ra+"&dec="+transient.dec+"&scale=0.5&width="+126+"&height="+126+"&opt=G&query=&Grid=on");
    }

    function prepare_plotly_data(channel_config, transientSummary, transientView) {
      transientSummary["ra"]  = Plotly.d3.min(transientView.photopoints.map( function(d) {return d.content.ra;}));
      transientSummary["dec"] = Plotly.d3.min(transientView.photopoints.map( function(d) {return d.content.dec;}));
      transientSummary["tran_names"] = transientView["tran_names"]
      var ztfName = transientSummary["tran_names"][0]
      $("#targetname").html(ztfName).attr("href", "http://skipper.caltech.edu:8080/cgi-bin/growth/view_source.cgi?name="+ztfName);
      for (var i=1; i<transientSummary.tran_names.length; i++) {
        if (transientSummary.tran_names[i].startsWith("TNS")) {
          var name = transientSummary.tran_names[i].substr(3);
          $("#tnsname").text("TNS:"+name).attr("href", "https://wis-tns.weizmann.ac.il/object/"+name);
          break;
        }
      }
      
      var lcdata = get_plotly_data(transientView.photopoints, channel_config);
      var lclims = get_plotly_upperlimit(transientView.upperlimits);
      // alert(detections[0]._id);
      create_plot(transientSummary, lcdata, lclims);

      $("#tran-id").text(transientSummary.tran_id);
      $("#comp-id").text(b64toHex(transientSummary.latest_state.$binary));
      $.each(transientSummary.journal, function(k, v){
        var dt = v.dt;
        delete v.dt;
        $("#t0-runs").append(
          '<pre id="run-item-' + k + '" style="text-align: center">' +
          '<div style="text-align: left; display: inline-block;">' + 
          JSON.stringify(v, undefined, 2) + 
          '</div></pre>'
        );
        $("#t0-list").append(
          '<a class="list-group-item list-group-item-action ' + tierColor(v) + 
          '" href="#run-item-' + k + '">' + unixTimestampToDate(dt) + '</a>'
        )
      });
      //$("#t0-runs").text(JSON.transient.journal)

      $('.list-group-item').on('click', function() {
        console.log($($(this).attr("href")));
        $(this).addClass("active").siblings().removeClass("active");
        $($(this).attr("href")).addClass("font-weight-bold").siblings().removeClass("font-weight-bold");
      });
    }

    function create_plot(transientSummary, lcdata, lclims) {

      // FIXME make async
      load_sdss_image(transientSummary);

      var data = [
          // PhotoPoints
          {
            x: lcdata.x,
            y: lcdata.y,
            cutoutURL: lcdata.cutoutURL,
            error_y: {
              type: 'data',
              array: lcdata.dy,
              color: "grey",
            },
            text: lcdata.id,
            // shape
            mode: 'markers',
            type: 'scatter',
            name: "photopoints",
            marker: {
              size: 15,
              color: lcdata.colors,
              line: {width:1, color:"grey"},
            }
          },
          //Upper Limits
          {
            x: lclims.x,
            y: lclims.y,
            mode: 'markers',
            type: 'scatter',
            hidden: true,
            name: "upper limits",
            marker: {
              size: 5,
              color: lcdata.colors,
              symbol: 6,

            }
          }
      ];


        var margin = {top:30};
        var myDiv = document.getElementById('lc_plot');
        var sdssimg = document.getElementById("sdssimg");
        var layout = {
            //title: transient.ztfName,
          hovermode: "closest",
            autoscale: false,
            height: "px",
            margin: {t: margin.top},
            font: {size: 18},
            showlegend: true,
            legend: {
                bgcolor: "rgba(255,255,255,0.1)",
                x: 0.,
                y: 1,
                //traceorder: 'normal',
                font: {
                  family: 'Arial, sans-serif',
                  size: 12,
                }
              },
            xaxis: {
              mirror:'ticks',
              linewidth: 1,
              tickfont: {
                  family: 'Arial, sans-serif',
                  size: 14,
                  color: 'grey'
                },
              title: "Date",
              titlefont: {
                  family: 'Arial, sans-serif',
                  size: 18,
                  color: 'grey'
                },
            },
            yaxis: {
              mirror:'ticks',
              autorange: 'reversed',
              linewidth: 1,
              tickfont: {
                  family: 'Arial, sans-serif',
                  size: 14,
                  color: 'grey'
                },
              title: "Mag (magpsf)",
              titlefont: {
                  family: 'Arial, sans-serif',
                  size: 18,
                  color: 'grey'
                },
            },
          };

        var config = {
          responsive: true,
          displayModeBar:false
        };


        var plot = Plotly.newPlot(myDiv, data, layout, config);
        var viewer = new FitsViewer();
        if (lcdata.cutoutURL.length > 0) {
          viewer.processFile(lcdata.cutoutURL[argMax(lcdata.x)],
            function(event) {
              alert("No alert issued for candid "+point.data.text[point.pointNumber])
            },
            function(event) {}
          );
        }
        myDiv.on('plotly_click', function(data){
          for (var i in data.points) {
            if (data.points[i].curveNumber == 0) {
              var point = data.points[i];
              viewer.processFile(point.data.cutoutURL[point.pointNumber],
                function(event) {
                  alert("No alert issued for candid "+point.data.text[point.pointNumber])
                },
                function(event) {}
              );
              break;
            }
          }
        });
      
    }

    $(document).ready(
      function() {
        const urlParams = new URLSearchParams(window.location.search);
        const targetName = urlParams.get('target');
        const channel = urlParams.get('channel');
        $("#channelname").html(channel);
        $("#channelname-form").attr('value',channel);
        var url = window.location.href.substr(0, window.location.href.lastIndexOf('?'));
        url = url.substr(0, url.lastIndexOf('/'));
        $.getJSON(url+'/'+channel+'/channel.json',
          null,
          function (channelConfig) {
            load_transient_data(channelConfig, targetName, prepare_plotly_data);
            document.getElementById("downloadlink").setAttribute("href", channelConfig.baseURL+"/download?path=%2F"+targetName+"&files=dump.json");
          })
      }
    );

  </script>

</head>

  <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
    <ul class="navbar-nav">

      <li class="nav-item active">
        <a id="downloadlink" class="btn btn-outline-light btn-md" role="button" aria-pressed="true" style="margin-top: 5px"><i class="fa fa-download"></i></a>
      </li>

      <li class="nav-item active">
        <a class="nav-link" id="targetname"></a>
      </li>

      <li class="nav-item active">
        <a class="nav-link" id="tnsname"></a>
      </li>

      <li class="nav-item">
        <a class="nav-link" id="channelname" href="#">Channel</a>
      </li>
    </ul>

    <form class="form-inline my-2 my-lg-0  ml-auto", method="GET">
        <input class="form-control mr-sm-2" type="search" id="target" name="target", placeholder="Target Name" aria-label="Search">
        <input type="hidden" id="channelname-form" name="channel">
    </form>

  </nav>




  <wrapper class="d-flex flex-column">
    <main role="main" class="container-fluid" style="margin-top: 10">
      <div class="row">
        <div class="col-md-8 col-sm-11" id="lc_plot"> </div>
        <div class="col-md-4 col-sm-1 text-center" id="FITSViewer" style="margin-top: 30">
          <div class="row">
            <div class="thumbnail col-md-6 col-sm-6">
              <canvas id="FITSimage_difference" class="img-responsive ztf-cutout" alt="difference image"></canvas>
            </div>
            <div class="thumbnail col-md-6 col-sm-6">
              <canvas id="FITSimage_science" class="img-responsive ztf-cutout" alt="science image"></canvas>
            </div>
          </div>
          
          <div class="row" style="margin-top: 10">
            <div class="thumbnail col-md-6 col-sm-6">
              <canvas id="FITSimage_template" class="img-responsive ztf-cutout" alt="reference image"></canvas>
            </div>
            <div class="thumbnail col-md-6 col-sm-6">
                <a id="sdsslink" target="_blank">
                
                <img id="sdssimg" class="img-responsive ztf-cutout" alt="Responsive image">
                </a>
                
              </div>
          </div>
        </div>
        

        
        <!-- <div class="col-md-push-8 col-md-3 col-sm-4"  style="margin-top: 30">

              <div class="row">
                <div class="col-12"  style="margin-top: 10">
                  <a id="marshallink" class="btn btn-outline-dark btn-md btn-block" role="button" aria-pressed="true">Access the marshal</a>
                </div>
              </div>
        </div> -->
      </div>
      <div class="row">
        <div class="col-12"><hr size="50"></div>
      </div>
      <div class="row text-center text-middle">
        <div class="col-2 anyClass">
          <div id="t0-list" class="list-group">
          </div>
        </div>
        <div class="col-6 anyClass2">
          <div data-spy="scroll" data-target="#run-list" data-offset=0>
            <ul id="t0-runs">
            </ul>
          </div>
        </div>
      </div>

  </main>
  <footer class="footer fixed-bottom text-center bg-light border-top">
    <nav class="navbar navbar-expand-sm bg-light py-0 navbar-light" style="font-size:15px">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link">Ampel</a>
        </li>
        <li class="nav-item">
          <div class="nav-link"> | </div>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="mailto:ampel-info@desy.de">Contact us</a>
        </li>
      </ul>

      <form class="form-inline my-2 my-lg-0  ml-auto">
          <a class="nav-link fa" style="color:black;font-size:24px" href="https://github.com/AmpelProject" target="_blank"> &#xf09b; </a>
      </form>
    </nav>

  </footer>
  </wrapper>

</body>
